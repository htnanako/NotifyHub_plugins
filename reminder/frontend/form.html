<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>编辑提醒</title>
  <script>
    try { tailwind = tailwind || {}; } catch (e) { /* ignore */ }
    try { tailwind.config = Object.assign({}, tailwind.config || {}, { darkMode: 'class' }); } catch (e) { /* ignore */ }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .bg-background {
      background-color: #030816 !important;
    }
  </style>
  <script>
    (function () {
      function updateTheme(theme) {
        var t = (theme || '').toString().toLowerCase() === 'dark' ? 'dark' : 'light';
        var root = document.documentElement;
        if (t === 'dark') root.classList.add('dark'); else root.classList.remove('dark');
        try { root.setAttribute('data-theme', t); } catch (e) { }
        root.style.colorScheme = t;
        var body = document.body;
        if (!body) return;
        if (t === 'dark') {
          body.classList.remove('text-gray-900');
          body.classList.add('bg-background', 'text-gray-100');
        } else {  
          body.classList.remove('bg-background', 'text-gray-100');
          body.classList.add('text-gray-900');
        }

        // 同步主题到弹窗
        syncThemeToModals(t);

        try { localStorage.setItem('nhtheme', t); } catch (e) { }
        window.nhtheme = t;
        try { console.log('[reminder:form] theme updated ->', t, 'html.classes=', root.className); } catch (e) { }
      }

      // 同步主题到所有弹窗和下拉菜单
      function syncThemeToModals(theme) {
        var containers = document.querySelectorAll('[data-theme-container]');
        containers.forEach(function (container) {
          container.setAttribute('data-theme', theme);

          if (theme === 'dark') {
            // 深色模式样式
            container.classList.remove('bg-white', 'text-gray-900');
            container.classList.add('bg-gray-900', 'text-gray-100');

            // 更新子元素样式
            container.querySelectorAll('button:not(.bg-blue-600)').forEach(function (btn) {
              btn.classList.remove('bg-white', 'border-gray-300');
              btn.classList.add('bg-gray-800', 'border-gray-700');
            });

            container.querySelectorAll('[id$="Menu"]').forEach(function (menu) {
              menu.classList.remove('bg-white', 'border-gray-200');
              menu.classList.add('bg-gray-900', 'border-gray-700');
            });
          } else {
            // 浅色模式样式
            container.classList.remove('bg-gray-900', 'text-gray-100');
            container.classList.add('bg-white', 'text-gray-900');

            // 更新子元素样式
            container.querySelectorAll('button:not(.bg-blue-600)').forEach(function (btn) {
              btn.classList.remove('bg-gray-800', 'border-gray-700');
              btn.classList.add('bg-white', 'border-gray-300');
            });

            container.querySelectorAll('[id$="Menu"]').forEach(function (menu) {
              menu.classList.remove('bg-gray-900', 'border-gray-700');
              menu.classList.add('bg-white', 'border-gray-200');
            });
          }
        });

        // 特别处理所有下拉菜单的选项
        var dropdownButtons = document.querySelectorAll('button[data-theme-container]');
        dropdownButtons.forEach(function (btn) {
          btn.setAttribute('data-theme', theme);

          if (!btn.disabled) {
            if (theme === 'dark') {
              btn.classList.remove('text-gray-700', 'hover:bg-blue-50');
              btn.classList.add('text-gray-200', 'hover:bg-gray-800');
            } else {
              btn.classList.remove('text-gray-200', 'hover:bg-gray-800');
              btn.classList.add('text-gray-700', 'hover:bg-blue-50');
            }
          }
        });
        var dropdownBtns = document.querySelectorAll('button[data-theme-btn]');
        dropdownBtns.forEach(function (btn) {
          btn.setAttribute('data-theme', theme);
          if (theme === 'dark') {
            btn.classList.remove('bg-white');
            btn.classList.add('text-gray-100');
          } else {
            btn.classList.remove('text-gray-100');
            btn.classList.add('bg-white', 'text-gray-900');
          }
        });
      }
      function getThemeFromParent() {
        try { if (window.parent && window.parent !== window) { var t = window.parent.nhtheme; if (t === 'light' || t === 'dark') return t; } } catch (e) { }
        try { var s = localStorage.getItem('nhtheme'); if (s === 'light' || s === 'dark') return s; } catch (e) { }
        return 'light';
      }
      window.addEventListener('message', function (event) {
        if (!event || !event.data) return;
        var type = (event.data.type || '').toString();
        if (type === 'injectTheme' || type.toLowerCase() === 'inject-theme') {
          var theme = (event.data.theme || (event.data.payload && event.data.payload.theme) || '').toString().toLowerCase();
          if (theme === 'light' || theme === 'dark') updateTheme(theme);
        }
      });
      document.addEventListener('DOMContentLoaded', function () { updateTheme(getThemeFromParent()); });
    })();
  </script>
  <style>
    :root {
      color-scheme: light;
    }

    input[type="date"],
    input[type="time"] {
      background-color: #ffffff;
      color: #111827;
      color-scheme: light;
    }

    /* WebKit 浅色内部区域与图标 */
    input[type="date"]::-webkit-datetime-edit,
    input[type="time"]::-webkit-datetime-edit {
      color: #111827;
    }

    input[type="date"]::-webkit-datetime-edit-fields-wrapper,
    input[type="time"]::-webkit-datetime-edit-fields-wrapper {
      background-color: #ffffff;
    }

    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="time"]::-webkit-calendar-picker-indicator {
      filter: invert(0);
      opacity: .8;
    }
  </style>
</head>

<body class="bg-white text-gray-900">
  <header>
    <div class="w-full px-6 py-6">
      <h1 class="text-2xl font-semibold data-[theme=dark]:text-gray-100">编辑Reminder任务</h1>
      <p class="text-sm text-gray-500 mt-1 data-[theme=dark]:text-gray-400">配置一次性或循环Reminder任务</p>
    </div>
  </header>

  <main class="w-full px-6 py-8">
    <form id="reminderForm" class="w-full">
      <div class="grid grid-cols-1 gap-6">
        <!-- 标题 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2 data-[theme=dark]:text-gray-200">标题</label>
          <input id="title" type="text" placeholder="请输入Reminder标题" required
            class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 data-[theme=dark]:bg-gray-800 data-[theme=dark]:border-gray-700 data-[theme=dark]:text-gray-200" />
          <p id="err-title" class="mt-2 text-xs text-red-600 hidden"></p>
        </div>

        <!-- 内容 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2 data-[theme=dark]:text-gray-200">内容</label>
          <textarea id="content" rows="6" placeholder="请输入Reminder内容" required
            class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 data-[theme=dark]:bg-gray-800 data-[theme=dark]:border-gray-700 data-[theme=dark]:text-gray-200"></textarea>
          <p id="err-content" class="mt-2 text-xs text-red-600 hidden"></p>
        </div>

        <!-- 类型 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2 data-[theme=dark]:text-gray-200">Reminder类型</label>
          <div class="flex items-center gap-6">
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="reminder_type" value="onetime" class="h-4 w-4 text-blue-600 border-gray-300"
                checked />
              <span class="text-sm">一次性（Date）</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="reminder_type" value="circle" class="h-4 w-4 text-blue-600 border-gray-300" />
              <span class="text-sm">循环（Cron）</span>
            </label>
          </div>
        </div>

        <!-- 一次性时间选择（Tailwind 自定义组件） -->
        <div id="section-onetime">
          <label
            class="block text-sm font-medium text-gray-700 mb-2 data-[theme=dark]:text-gray-200">Reminder时间（一次性）</label>
          <!-- 隐藏真实值，便于复用既有校验与提交逻辑 -->
          <input id="date" type="hidden" />
          <input id="time" type="hidden" />
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <button type="button" id="btnPickDate"
              class="w-full rounded-lg border px-3 py-2 text-left hover:border-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500 data-[theme=light]:bg-white data-[theme=light]:border-gray-300 data-[theme=light]:text-gray-900 data-[theme=dark]:bg-gray-800 data-[theme=dark]:border-gray-700 data-[theme=dark]:text-gray-100">
              <!-- <span class="block text-xs text-gray-500">日期</span> -->
              <span id="dateDisplay"
                class="block data-[theme=light]:text-gray-900 data-[theme=dark]:text-gray-100">请选择日期</span>
            </button>
            <button type="button" id="btnPickTime"
              class="w-full rounded-lg border px-3 py-2 text-left hover:border-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500 data-[theme=light]:bg-white data-[theme=light]:border-gray-300 data-[theme=light]:text-gray-900 data-[theme=dark]:bg-gray-800 data-[theme=dark]:border-gray-700 data-[theme=dark]:text-gray-100">
              <!-- <span class="block text-xs text-gray-500">时间</span> -->
              <span id="timeDisplay"
                class="block data-[theme=light]:text-gray-900 data-[theme=dark]:text-gray-100">请选择时间</span>
            </button>
          </div>
          <p class="text-xs mt-2 data-[theme=light]:text-gray-500 data-[theme=dark]:text-gray-400">将自动合并为 YYYY-MM-DD
            HH:mm</p>
          <p id="err-onetime" class="mt-2 text-xs text-red-600 hidden"></p>
        </div>

        <!-- 循环 Cron 输入 -->
        <div id="section-circle" class="hidden">
          <label class="block text-sm font-medium text-gray-700 mb-2 data-[theme=dark]:text-gray-200">Cron
            表达式（循环）</label>
          <input id="cron" type="text" placeholder="如：0 9 * * 1（每周一 09:00）或 30 2 * * *（每日 02:30）"
            class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 data-[theme=dark]:bg-gray-900 data-[theme=dark]:border-gray-700 data-[theme=dark]:text-gray-200" />
          <p class="text-xs text-gray-500 mt-2 data-[theme=dark]:text-gray-400">格式：分钟 小时 日 月 周（5 段）。</p>
          <p id="err-cron" class="mt-2 text-xs text-red-600 hidden"></p>
        </div>

        <!-- 通知通道（放在状态上方，Tailwind 自定义下拉） -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2 data-[theme=dark]:text-gray-200">通知通道</label>
          <div class="relative">
            <button type="button" id="notifyDropdownBtn" data-theme-btn
              class="w-full rounded-lg border px-3 py-2 text-left hover:border-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white border-gray-300"
              data-theme="light">
              <span id="notifyDropdownLabel">请选择</span>
            </button>
            <div id="notifyDropdownMenu" data-theme-container
              class="hidden absolute left-0 right-0 z-10 mt-1 rounded-lg border shadow bg-white border-gray-200"
              data-theme="light">
              <div id="notifyDropdownOptions" class="max-h-60 overflow-auto py-1"></div>
            </div>
          </div>
          <p id="err-notify-route" class="mt-2 text-xs text-red-600 hidden"></p>
        </div>

        <!-- 状态（移至底部，保存按钮上方） -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2 data-[theme=dark]:text-gray-200">启用状态</label>
          <div class="flex items-center gap-6">
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="status" value="1" class="h-4 w-4 text-blue-600 border-gray-300" checked />
              <span class="text-sm">启用</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="status" value="0" class="h-4 w-4 text-blue-600 border-gray-300" />
              <span class="text-sm">禁用</span>
            </label>
          </div>
        </div>

        <!-- 操作 -->
        <div class="flex items-center gap-4">
          <button type="button" id="btnSave"
            class="inline-flex items-center justify-center px-5 py-2.5 rounded-lg bg-blue-600 text-white hover:bg-blue-700">保存</button>
          <a href="index.html"
            class="inline-flex items-center justify-center px-5 py-2.5 rounded-lg border bg-white text-gray-700 hover:text-gray-900 data-[theme=dark]:bg-gray-900 data-[theme=dark]:text-gray-200 data-[theme=dark]:border-gray-700">取消</a>
        </div>
      </div>
    </form>
  </main>

  <script>
    function $(id) { return document.getElementById(id); }
    function getRadio(name) {
      const els = document.querySelectorAll(`input[name="${name}"]`);
      for (const el of els) { if (el.checked) return el.value; }
      return '';
    }
    function getSelectValue(id) { const el = $(id); return el ? (el.value || '') : ''; }
    // 通用下拉菜单项渲染
    function buildMenuOptions(container, values, onSelect) {
      if (!container) return;
      container.innerHTML = '';
      values.forEach(({ value, label, disabled }) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        // 根据当前主题设置不同的悬停背景色
        const isDarkMode = document.documentElement.classList.contains('dark');
        btn.className = `w-full text-left px-3 py-2 ${disabled ? 'text-gray-300 cursor-not-allowed' : isDarkMode ? 'text-gray-200 hover:bg-gray-800' : 'text-gray-700 hover:bg-blue-50'}`;
        // 添加到主题容器中，以便主题切换时更新
        btn.setAttribute('data-theme-container', '');
        btn.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
        btn.textContent = label;
        btn.disabled = !!disabled;
        if (!disabled) btn.addEventListener('click', () => onSelect(value, label));
        container.appendChild(btn);
      });
    }

    // 限制一次性提醒的日期/时间不得早于当前
    function pad2(n) { return n < 10 ? `0${n}` : `${n}`; }
    function fmtDate(d) { return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`; }
    function fmtTime(d) { return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }
    function updateDateTimeMins() {
      const now = new Date();
      const today = fmtDate(now);
      const dateEl = $('date');
      const timeEl = $('time');
      if (!dateEl || !timeEl) return;
      // 限制日期最小为今天
      dateEl.min = today;
      const selectedDate = dateEl.value;
      if (selectedDate === today) {
        const minTime = fmtTime(now);
        timeEl.min = minTime;
        if (timeEl.value && timeEl.value < minTime) {
          timeEl.value = minTime;
        }
      } else {
        timeEl.min = "00:00";
      }
    }

    function syncSections() {
      const type = getRadio('reminder_type');
      const isOnetime = type === 'onetime';
      $('section-onetime').classList.toggle('hidden', !isOnetime);
      $('section-circle').classList.toggle('hidden', isOnetime);
    }

    document.querySelectorAll('input[name="reminder_type"]').forEach((el) => {
      el.addEventListener('change', syncSections);
    });
    syncSections();

    // 绑定日期变化，动态限制时间最小值
    ['date', 'time'].forEach(id => {
      const el = $(id); if (el) el.addEventListener('change', updateDateTimeMins);
    });
    updateDateTimeMins();

    // 读取查询参数（编辑模式占位）
    function getQuery(k) {
      try { return new URLSearchParams(location.search).get(k); } catch (e) { return null; }
    }
    const editingId = getQuery('id');
    let presetNotifyRoute = '';
    const API_BASE = '/api/plugins/reminder';
    async function fetchDetail(id) {
      try {
        const res = await fetch(`${API_BASE}/tasks/${encodeURIComponent(id)}`);
        const data = await res.json();
        if (data && data.data) return data.data;
      } catch (e) { }
      return null;
    }
    async function fillFormByData(d) {
      if (!d) return;
      $('title').value = d.title || '';
      $('content').value = d.content || '';
      (document.querySelector(`input[name="status"][value="${d.status ? '1' : '0'}"]`) || {}).checked = true;
      (document.querySelector(`input[name="reminder_type"][value="${d.reminder_type}"]`) || {}).checked = true;
      syncSections();
      if (d.reminder_type === 'onetime') {
        // 尝试拆分 YYYY-MM-DD HH:mm
        const parts = (d.reminder_time || '').split(/\s+/);
        if (parts.length >= 2) {
          const dateValue = parts[0];
          const timeValue = parts[1].slice(0, 5);
          $('date').value = dateValue;
          $('time').value = timeValue;
          // 更新显示文本
          setDateValue(dateValue);
          setTimeValue(timeValue);
        }
        updateDateTimeMins();
      } else if (d.reminder_type === 'circle') {
        $('cron').value = d.reminder_time || '';
      }
      // 通知通道选中
      try {
        presetNotifyRoute = String(d.notify_route || '');
        const lbl = document.getElementById('notifyDropdownLabel');
        if (lbl) {
          lbl.dataset.value = presetNotifyRoute;
        }
      } catch (e) { }
    }
    (async function initEdit() {
      if (editingId) {
        const d = await fetchDetail(editingId);
        await fillFormByData(d);
      }
    })();

    // —— 日期时间选择组件 ——
    function setDateValue(val) {
      $('date').value = val;
      $('dateDisplay').textContent = val || '请选择日期';
      $('date').dispatchEvent(new Event('change'));
    }
    function setTimeValue(val) {
      $('time').value = val;
      $('timeDisplay').textContent = val || '请选择时间';
      $('time').dispatchEvent(new Event('change'));
    }
    // 初始化显示为已有值或空
    setDateValue($('date').value || '');
    setTimeValue($('time').value || '');

    // 日期弹窗
    const dateModalId = 'datePickerModal';
    const timeModalId = 'timePickerModal';
    function openModal(id) { document.getElementById(id)?.classList.remove('hidden'); syncThemeToModals(window.nhtheme || 'light'); }
    function closeModal(id) { document.getElementById(id)?.classList.add('hidden'); }

    $('btnPickDate').addEventListener('click', () => { renderCalendar(); openModal(dateModalId); });
    $('btnPickTime').addEventListener('click', () => { renderTimePicker(); openModal(timeModalId); });

    // 日历渲染
    let calCurrent = new Date();
    function formatYMD(d) {
      const y = d.getFullYear();
      const m = (d.getMonth() + 1).toString().padStart(2, '0');
      const da = d.getDate().toString().padStart(2, '0');
      return `${y}-${m}-${da}`;
    }
    function startOfMonth(d) { return new Date(d.getFullYear(), d.getMonth(), 1); }
    function endOfMonth(d) { return new Date(d.getFullYear(), d.getMonth() + 1, 0); }
    function isPastDate(ymd) {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const [y, m, da] = ymd.split('-').map(n => parseInt(n, 10));
      const t = new Date(y, m - 1, da);
      return t < today; // 禁止今天之前
    }
    function renderCalendar() {
      const container = document.getElementById('calendarGrid');
      const header = document.getElementById('calendarHeader');
      if (!container || !header) return;
      container.innerHTML = '';
      header.textContent = `${calCurrent.getFullYear()}年 ${calCurrent.getMonth() + 1}月`;
      const first = startOfMonth(calCurrent);
      const last = endOfMonth(calCurrent);
      const startWeek = first.getDay(); // 0=周日
      for (let i = 0; i < startWeek; i++) {
        const cell = document.createElement('div');
        container.appendChild(cell);
      }
      for (let day = 1; day <= last.getDate(); day++) {
        const ymd = formatYMD(new Date(calCurrent.getFullYear(), calCurrent.getMonth(), day));
        const btn = document.createElement('button');
        btn.type = 'button';
        const disabled = isPastDate(ymd);
        if (disabled) {
          btn.className = 'h-10 rounded-lg border cursor-not-allowed data-[theme=light]:text-gray-300 data-[theme=light]:border-gray-200 data-[theme=dark]:text-gray-500 data-[theme=dark]:border-gray-700';
        } else {
          btn.className = 'h-10 rounded-lg border hover:border-blue-300 data-[theme=light]:border-gray-300 data-[theme=dark]:border-gray-700 data-[theme=dark]:text-gray-100';
        }
        btn.textContent = String(day);
        if (!disabled) btn.addEventListener('click', () => { setDateValue(ymd); closeModal(dateModalId); });
        container.appendChild(btn);
      }
    }
    function calPrev() { calCurrent = new Date(calCurrent.getFullYear(), calCurrent.getMonth() - 1, 1); renderCalendar(); }
    function calNext() { calCurrent = new Date(calCurrent.getFullYear(), calCurrent.getMonth() + 1, 1); renderCalendar(); }

    // 时间选择
    function renderTimePicker() {
      const hourMenu = document.getElementById('hourMenu');
      const minuteMenu = document.getElementById('minuteMenu');
      const hourBtn = document.getElementById('hourBtn');
      const minuteBtn = document.getElementById('minuteBtn');
      if (!hourMenu || !minuteMenu || !hourBtn || !minuteBtn) return;
      hourMenu.innerHTML = ''; minuteMenu.innerHTML = '';
      const now = new Date();
      const todayStr = formatYMD(now);
      const selectedDate = $('date').value || '';
      const minHour = (selectedDate === todayStr) ? now.getHours() : 0;
      const minMinuteBase = now.getMinutes();
      const hours = [];
      for (let h = 0; h < 24; h++) {
        hours.push({ value: String(h).padStart(2, '0'), label: String(h).padStart(2, '0'), disabled: h < minHour });
      }
      const currentHour = $('time').value ? parseInt(($('time').value.split(':')[0] || '0'), 10) : Math.max(minHour, now.getHours());
      hourBtn.textContent = String(currentHour).padStart(2, '0');
      buildMenuOptions(hourMenu, hours, (value, label) => {
        hourBtn.textContent = label;
        hourBtn.dataset.value = value;
        hourMenu.classList.add('hidden');
        const chosenHour = parseInt(value, 10);
        const effectiveMinMinute2 = (selectedDate === todayStr && chosenHour === minHour) ? minMinuteBase : 0;
        const minutes2 = [];
        for (let m = 0; m < 60; m++) {
          minutes2.push({ value: String(m).padStart(2, '0'), label: String(m).padStart(2, '0'), disabled: m < effectiveMinMinute2 });
        }
        minuteBtn.textContent = String(Math.max(effectiveMinMinute2, 0)).padStart(2, '0');
        minuteBtn.dataset.value = minuteBtn.textContent;
        buildMenuOptions(minuteMenu, minutes2, (v, lab) => { minuteBtn.textContent = lab; minuteBtn.dataset.value = v; minuteMenu.classList.add('hidden'); });
      });
      const effectiveMinMinute = (selectedDate === todayStr && currentHour === minHour) ? minMinuteBase : 0;
      const minutes = [];
      for (let m = 0; m < 60; m++) {
        minutes.push({ value: String(m).padStart(2, '0'), label: String(m).padStart(2, '0'), disabled: m < effectiveMinMinute });
      }
      const currentMinute = $('time').value ? parseInt(($('time').value.split(':')[1] || '0'), 10) : Math.max(effectiveMinMinute, now.getMinutes());
      minuteBtn.textContent = String(currentMinute).padStart(2, '0');
      buildMenuOptions(minuteMenu, minutes, (value, label) => { minuteBtn.textContent = label; minuteBtn.dataset.value = value; minuteMenu.classList.add('hidden'); });
      hourBtn.onclick = () => { hourMenu.classList.toggle('hidden'); minuteMenu.classList.add('hidden'); };
      minuteBtn.onclick = () => { minuteMenu.classList.toggle('hidden'); hourMenu.classList.add('hidden'); };
    }
    function confirmTimePicker() {
      const hEl = document.getElementById('hourBtn');
      const mEl = document.getElementById('minuteBtn');
      const h = (hEl && hEl.dataset && hEl.dataset.value) ? hEl.dataset.value : (hEl.textContent || '00');
      const m = (mEl && mEl.dataset && mEl.dataset.value) ? mEl.dataset.value : (mEl.textContent || '00');
      setTimeValue(`${h}:${m}`);
      closeModal(timeModalId);
    }

    function buildPayload() {
      const status = getRadio('status') === '1';
      const reminder_type = getRadio('reminder_type');
      let reminder_time = '';
      if (reminder_type === 'onetime') {
        const d = $('date').value || '';
        const t = $('time').value || '';
        if (d && t) reminder_time = `${d} ${t}`; // YYYY-MM-DD HH:mm
      } else {
        reminder_time = ($('cron').value || '').trim();
      }
      const lbl = document.getElementById('notifyDropdownLabel');
      const notify_route = (lbl && lbl.dataset ? (lbl.dataset.value || '') : '');
      return {
        id: editingId || undefined,
        title: $('title').value || '',
        content: $('content').value || '',
        status,
        reminder_type,
        reminder_time,
        notify_route,
      };
    }

    function showError(el, msg, errEl) {
      if (!el || !errEl) return;
      el.classList.add('border-red-500', 'focus:ring-red-500', 'focus:border-red-500');
      errEl.textContent = msg || '';
      errEl.classList.remove('hidden');
    }
    function clearError(el, errEl) {
      if (!el || !errEl) return;
      el.classList.remove('border-red-500', 'focus:ring-red-500', 'focus:border-red-500');
      errEl.textContent = '';
      errEl.classList.add('hidden');
    }
    function validateRequired() {
      let ok = true;
      const titleEl = $('title');
      const contentEl = $('content');
      const errTitle = $('err-title');
      const errContent = $('err-content');
      // 清空
      clearError(titleEl, errTitle);
      clearError(contentEl, errContent);
      // 标题/内容
      if (!(titleEl.value || '').trim()) { showError(titleEl, '请填写标题', errTitle); ok = false; }
      if (!(contentEl.value || '').trim()) { showError(contentEl, '请填写内容', errContent); ok = false; }

      const type = getRadio('reminder_type');
      const errOnetime = $('err-onetime');
      const errCron = $('err-cron');
      const dateEl = $('date');
      const timeEl = $('time');
      const cronEl = $('cron');
      clearError(dateEl, errOnetime);
      clearError(timeEl, errOnetime);
      clearError(cronEl, errCron);

      if (type === 'onetime') {
        const d = (dateEl.value || '').trim();
        const t = (timeEl.value || '').trim();
        if (!d) { showError(dateEl, '请选择日期', errOnetime); ok = false; }
        if (!t) { showError(timeEl, '请选择时间', errOnetime); ok = false; }
      } else if (type === 'circle') {
        const cron = (cronEl.value || '').trim();
        if (!cron) { showError(cronEl, '请填写 Cron 表达式', errCron); ok = false; }
        const parts = cron.split(/\s+/).filter(Boolean);
        if (cron && parts.length !== 5) { showError(cronEl, 'Cron 需为5段：分钟 小时 日 月 周', errCron); ok = false; }
      }
      // 通知通道必选
      const notify = (document.getElementById('notifyDropdownLabel').dataset.value || '');
      const errNotify = $('err-notify-route');
      if (errNotify) { errNotify.classList.add('hidden'); errNotify.textContent = ''; }
      if (!notify) {
        if (errNotify) { errNotify.textContent = '请选择通知通道'; errNotify.classList.remove('hidden'); }
        $('notifyDropdownBtn') && $('notifyDropdownBtn').focus();
        ok = false;
      }
      return ok;
    }

    function validateOnetimeNotPast() {
      if (getRadio('reminder_type') !== 'onetime') return true;
      const d = $('date').value; const t = $('time').value;
      if (!d || !t) return true;
      const candidate = new Date(`${d}T${t}:00`);
      const now = new Date();
      if (candidate.getTime() < now.getTime()) {
        const errOnetime = $('err-onetime');
        showError($('time'), '一次性提醒时间不能早于当前时间', errOnetime);
        updateDateTimeMins();
        return false;
      }
      return true;
    }

    // 简单请求封装
    async function apiRequest(path, options) {
      const res = await fetch(`${API_BASE}${path}`, {
        headers: { 'Content-Type': 'application/json' },
        ...options,
      });
      let data = null;
      try { data = await res.json(); } catch (e) { }
      if (!res.ok) {
        const msg = (data && (data.message || data.detail)) || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data;
    }

    // 底部错误提示
    const actionErrId = 'err-action';
    (function ensureActionErr() {
      let el = document.getElementById(actionErrId);
      if (!el) {
        const p = document.createElement('p');
        p.id = actionErrId;
        p.className = 'mt-2 text-sm text-red-600 hidden';
        document.querySelector('#reminderForm .flex.items-center.gap-4')?.appendChild(p);
      }
    })();
    function showActionError(msg) {
      const el = document.getElementById(actionErrId);
      if (el) { el.textContent = msg || '操作失败'; el.classList.remove('hidden'); }
    }
    function clearActionError() {
      const el = document.getElementById(actionErrId);
      if (el) { el.textContent = ''; el.classList.add('hidden'); }
    }

    $('btnSave').addEventListener('click', async () => {
      clearActionError();
      if (!validateRequired()) return;
      if (!validateOnetimeNotPast()) return;
      const payload = buildPayload();
      const isUpdate = !!payload.id;
      const btn = $('btnSave');
      const prev = btn.textContent;
      btn.disabled = true; btn.textContent = isUpdate ? '保存中...' : '创建中...';
      try {
        if (isUpdate) {
          await apiRequest(`/tasks/${encodeURIComponent(payload.id)}`, { method: 'PUT', body: JSON.stringify(payload) });
        } else {
          await apiRequest('/tasks', { method: 'POST', body: JSON.stringify(payload) });
        }
        // 成功后返回列表
        location.href = 'index.html';
      } catch (e) {
        showActionError((e && e.message) || '保存失败');
      } finally {
        btn.disabled = false; btn.textContent = prev;
      }
    });

    // 拉取通知通道并渲染为自定义下拉
    async function loadNotifyRoutes() {
      try {
        const res = await fetch('/api/plugins/reminder/notify_route');
        const data = await res.json();
        const list = (data && Array.isArray(data.data)) ? data.data : [];
        const options = list.map(it => ({ value: String(it.value), label: String(it.label || it.value) }));
        const menu = document.getElementById('notifyDropdownOptions');
        const labelEl = document.getElementById('notifyDropdownLabel');
        const menuWrap = document.getElementById('notifyDropdownMenu');
        const btn = document.getElementById('notifyDropdownBtn');
        buildMenuOptions(menu, options, (value, label) => {
          if (labelEl) { labelEl.textContent = label; labelEl.dataset.value = value; }
          if (menuWrap) menuWrap.classList.add('hidden');
        });
        if (btn && menuWrap) {
          btn.addEventListener('click', (e) => { e.stopPropagation(); menuWrap.classList.toggle('hidden'); });
        }
        if (presetNotifyRoute && labelEl) {
          const preset = options.find(o => o.value === presetNotifyRoute);
          labelEl.textContent = (preset && preset.label) || '请选择';
          labelEl.dataset.value = presetNotifyRoute;
        }
      } catch (e) {
        // ignore
      }
    }
    loadNotifyRoutes();

    // 点击页面空白处关闭所有下拉
    function isInside(container, target) {
      return container && (container === target || container.contains(target));
    }
    document.addEventListener('click', (e) => {
      const t = e.target;
      const notifyMenu = document.getElementById('notifyDropdownMenu');
      const notifyBtn = document.getElementById('notifyDropdownBtn');
      if (notifyMenu && !notifyMenu.classList.contains('hidden') && !isInside(notifyMenu, t) && !isInside(notifyBtn, t)) {
        notifyMenu.classList.add('hidden');
      }
      const hourMenu = document.getElementById('hourMenu');
      const hourBtn = document.getElementById('hourBtn');
      if (hourMenu && !hourMenu.classList.contains('hidden') && !isInside(hourMenu, t) && !isInside(hourBtn, t)) {
        hourMenu.classList.add('hidden');
      }
      const minuteMenu = document.getElementById('minuteMenu');
      const minuteBtn = document.getElementById('minuteBtn');
      if (minuteMenu && !minuteMenu.classList.contains('hidden') && !isInside(minuteMenu, t) && !isInside(minuteBtn, t)) {
        minuteMenu.classList.add('hidden');
      }
    });
  </script>
  <!-- 日期选择对话框 -->
  <div id="datePickerModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/50" onclick="closeModal('datePickerModal')"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div data-theme-container class="w-full max-w-md rounded-xl shadow-lg bg-white text-gray-900" data-theme="light">
        <div class="px-5 pt-5 flex items-center justify-between">
          <button type="button" class="px-3 py-1 rounded border border-gray-300 flex items-center justify-center"
            onclick="calPrev()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                clip-rule="evenodd" />
            </svg>
          </button>
          <h3 id="calendarHeader" class="text-base font-semibold"></h3>
          <button type="button" class="px-3 py-1 rounded border border-gray-300 flex items-center justify-center"
            onclick="calNext()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                clip-rule="evenodd" />
            </svg>
          </button>
        </div>
        <div class="px-5 mt-3 grid grid-cols-7 gap-2 text-xs text-gray-500">
          <div>日</div>
          <div>一</div>
          <div>二</div>
          <div>三</div>
          <div>四</div>
          <div>五</div>
          <div>六</div>
        </div>
        <div id="calendarGrid" class="px-5 py-5 grid grid-cols-7 gap-2"></div>
        <div class="px-5 pb-5 flex items-center justify-end">
          <button type="button" class="px-4 h-10 rounded-lg border bg-white border-gray-300"
            onclick="closeModal('datePickerModal')">取消</button>
        </div>
      </div>
    </div>
  </div>
  <!-- 时间选择对话框 -->
  <div id="timePickerModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/50" onclick="closeModal('timePickerModal')"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div data-theme-container class="w-full max-w-sm rounded-xl shadow-lg p-5 bg-white text-gray-900"
        data-theme="light">
        <h3 class="text-base font-semibold">选择时间</h3>
        <div class="mt-4 grid grid-cols-2 gap-3">
          <div class="relative">
            <button type="button" id="hourBtn"
              class="w-full rounded-lg border px-3 py-2 text-left hover:border-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white border-gray-300">--</button>
            <div id="hourMenu"
              class="hidden absolute left-0 right-0 z-10 mt-1 rounded-lg border shadow max-h-60 overflow-auto bg-white border-gray-200">
            </div>
          </div>
          <div class="relative">
            <button type="button" id="minuteBtn"
              class="w-full rounded-lg border px-3 py-2 text-left hover:border-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white border-gray-300">--</button>
            <div id="minuteMenu"
              class="hidden absolute left-0 right-0 z-10 mt-1 rounded-lg border shadow max-h-60 overflow-auto bg-white border-gray-200">
            </div>
          </div>
        </div>
        <div class="mt-5 flex items-center justify-end gap-3">
          <button type="button" class="px-4 h-10 rounded-lg border bg-white border-gray-300"
            onclick="closeModal('timePickerModal')">取消</button>
          <button type="button" class="px-4 h-10 rounded-lg bg-blue-600 text-white"
            onclick="confirmTimePicker()">确定</button>
        </div>
      </div>
    </div>
  </div>
</body>

</html>