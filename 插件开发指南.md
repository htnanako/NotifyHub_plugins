## 插件开发指南

本文档介绍如何为 NotifyHub 开发插件，包括 `manifest.json` 规范、插件路由注册规范、插件配置读取、系统配置读取与内置发送消息功能的使用方法。

### 基础目录结构与加载

- **PLUGINS_DIR**: 在映射的`/data`目录下有`plugins`目录，系统会自动扫描该目录下的所有 Python 模块并注入其中的 `APIRouter`(若有)。
- **插件目录结构（建议）**:
  - `/data/plugins/<plugin_id>/manifest.json`
  - `/data/plugins/<plugin_id>/__init__.py`
  - `/data/plugins/<plugin_id>/*.py`

### 1. manifest.json 配置规范

顶层字段（均为字符串，除数组字段外）：

- **id**: 插件唯一 ID（建议与目录名相同）
- **name**: 插件名称
- **description**: 插件描述
- **author**: 作者
- **logo**: 插件 Logo 链接
- **version**: 版本号
- **documentation**: 文档链接(若无可设置空字符串)
- **path**: 插件在后端 API 下的路由前缀（建议与 `APIRouter(prefix=...)` 保持一致）
- **configField**: 配置表单字段数组
- **helpTextField**: 说明文本数组

配置表单字段 `configField`（数组，元素为对象）：

- **fieldName**: 字段键名（保存/读取用）
- **fieldType**: 字段类型，支持：
  - `string`（字符串类型）
  - `select`（单选下拉框）
  - `multi_select`（多选下拉框）
  - `switch`（开关）
- **label**: 字段显示名称
- **helpText**: 可选，辅助说明
- **defaultValue**: 可选，默认值（`string | boolean | string[]`）
- **required**: 可选，是否必填（默认必填；注意：`switch` 类型不参与必填校验）
- **options**: 可选，仅 `select`/`multi_select` 用。元素形如：`{ value: string, label: string, group?: string, type?: string, category?: string }`。其中 `group`/`type`/`category` 任一存在即可触发前端分组展示。

说明文本 `helpTextField`（数组，元素为对象）：

- **fieldType**: 支持：`title` | `text` | `code`
- **value**: 文本内容或代码内容。`code` 类型中支持占位符 `{site_url}`，前端会自动替换为系统配置的站点地址（或浏览器 `window.location.origin`）。

示例（节选自测试插件）：

```json
{
  "id": "plugin_test",
  "name": "插件测试",
  "description": "插件测试",
  "author": "NotifyHub",
  "logo": "https://example.com/logo.png",
  "version": "0.0.1",
  "documentation": "https://www.baidu.com",
  "path": "/plugin_test",
  "configField": [
    {
        "fieldName": "test_url",
        "fieldType": "string",
        "label": "测试URL",
        "helpText": "测试URL地址",
        "defaultValue": "https://www.baidu.com"
    },
    {
        "fieldName": "test_select",
        "fieldType": "select",
        "label": "测试单选配置项",
        "options": [
            {"value":"option1","label":"选项1"},
            {"value":"option2","label":"选项2"}
        ],
        "defaultValue": "option1"
    },
    {
        "fieldName": "test_multi_select",
        "fieldType": "multi_select",
        "label": "测试多选配置项",
        "options": [
            {"value":"option1","label":"选项1","type":"type1"},
            {"value":"option2","label":"选项2","type":"type1"},
            {"value":"option3","label":"选项3","type":"type2"}
        ],
        "defaultValue": ["option1", "option2"]
    },
    {
        "fieldName": "test_switch",
        "fieldType": "switch",
        "label": "测试开关配置项",
        "defaultValue": true
    }
  ],
  "helpTextField": [
    { "fieldType": "title", "value": "这是一个测试插件，这是说明文本的标题" },
    { "fieldType": "text", "value": "这是一个测试插件，这是说明文本的内容" },
    { "fieldType": "code", "value": "{site_url}/api/plugins/plugin_test/demo" }
  ]
}
```

### 2. 插件 APIRouter 注册要求

- 在插件任意 `.py` 模块(除__init__.py)内定义 FastAPI 的 `APIRouter` 实例，**变量名必须以 `router` 结尾**，例如：`my_plugin_router`、`event_router`。
- 建议为该 `APIRouter` 设置 `prefix` 为插件路由前缀，与 `manifest.json` 的 `path` 保持一致，便于自描述与排查。
- 系统会自动将第三方插件路由挂载到后端统一前缀下：`/api/plugins`。
  - 若 `APIRouter(prefix="/my_plugin")`，则最终路径形如：`/api/plugins/my_plugin/...`
- 是否注册成功，可放置文件到插件目录下后重启程序查看日志，是否有形如 `插件 my_plugin 注入路由 my_plugin_router: /api/plugins/my_plugin/ping` 的日志。

示例：

```python
from fastapi import APIRouter

my_plugin_router = APIRouter(prefix="/plugin_test", tags=["plugin_test"])

@my_plugin_router.get("/ping")
async def ping():
    return {"ok": True}
```

### 3. 插件配置获取（后端）

使用 `notifyhub.plugins.utils` 提供的便捷方法。

```python
from notifyhub.plugins.utils import (
    get_plugin_data,
    get_plugin_config,
    get_plugin_config_value,
    upsert_plugin_config,
)

plugin_id = "plugin_test"

# 获取原始存储数据（含名称等元信息）
data = get_plugin_data(plugin_id)  # 存在时返回字典，不存在返回 None

# 获取配置字典
config = get_plugin_config(plugin_id)  # 返回 dict，不存在时返回空字典 {}
```


### 4. 获取系统内其他配置（后端）

通过 `notifyhub.controller.server` 中的全局实例 `server` 获取渠道/通道的配置或名称列表。

```python
from notifyhub.controller.server import server

# 渠道配置列表（List[Dict]）
channels = server.notify_channels_config

# 渠道名称列表（List[str]）
channel_names = server.notify_channels_name

# 通道配置列表（List[Dict]）
routes = server.notify_routers_config

# 通道名称列表（List[str]）
route_names = server.notify_routers_name
```

### 5. 内置发送消息功能（后端）

同样使用 `server` 实例，支持直接向指定“渠道”或“通道”发送通知。

```python
from notifyhub.controller.server import server

# 按渠道发送（单个渠道）
server.send_notify_by_channel(
    channel_name="telegram",
    title="标题",
    content="内容",
    push_img_url="https://example.com/img.png",      # 可选
    push_link_url="https://example.com/detail"       # 可选
)

# 按通道发送（通道会绑定一个或多个渠道）
server.send_notify_by_router(
    route_id="my_route_id",
    title="标题",
    content="内容",
    push_img_url=None, # 可选
    push_link_url=None # 可选
)
```

### 建议与注意事项

- **命名一致性**：`manifest.json` 的 `id`、目录名和 `APIRouter(prefix=...)` 建议保持一致。
- **路由前缀**：请确保 `manifest.json.path` 与 `APIRouter(prefix=...)` 对齐，以便前后端引用一致、查找方便。
- **下拉分组**：在 `options` 中可使用 `group` / `type` / `category` 任一键进行分组；前端会自动识别并分组展示。
- **帮助占位符**：`helpTextField` 中 `code` 类型支持 `{site_url}` 占位符替换。
- **必填校验**：前端对 `switch` 类型不做必填校验；其他类型若未显式 `required:false`，默认视为必填。


