name: Package and Release Plugins

on:
  push:
    branches:
      - '**'

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare version tag (UTC)
        id: tag
        shell: bash
        run: |
          rand="$(openssl rand -hex 3)" # 6ä½åå…­è¿›åˆ¶éšæœºå­—ç¬¦ä¸²
          tag="v$(date -u +'%Y%m%d')-${rand}"
          echo "value=$tag" >> "$GITHUB_OUTPUT"

      - name: Zip each top-level directory
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          # æ‰“åŒ…æ ¹ç›®å½•ä¸‹çš„æ¯ä¸€ä¸ªä¸€çº§å­ç›®å½•ï¼ˆæ’é™¤ .gitã€.githubã€dist ç­‰ï¼‰
          while IFS= read -r -d '' dir; do
            name="$(basename "$dir")"
            zip -r "dist/${name}.zip" "$dir" -x "*/.git/*"
          done < <(find . -mindepth 1 -maxdepth 1 -type d \
                    -not -name ".git" \
                    -not -name ".github" \
                    -not -name "dist" \
                    -print0)

      - name: Generate release notes from commits
        id: notes
        shell: bash
        run: |
          set -euo pipefail
          # åˆ†ç»„ç”Ÿæˆå„ç±»å‹çš„ä¸´æ—¶è¯´æ˜æ–‡ä»¶
          types=(feat fix perf refactor docs style test build ci chore revert other)
          declare -A sectionMap=(
            [feat]="Features" [fix]="Bug Fixes" [docs]="Documentation" [refactor]="Code Refactoring"
            [perf]="Performance" [test]="Tests" [build]="Build System" [ci]="Continuous Integration"
            [style]="Styles" [revert]="Reverts" [chore]="Chores" [other]="Others"
          )
          declare -A emojiMap=(
            [feat]="ğŸ¸" [fix]="ğŸ›" [docs]="ğŸ“" [refactor]="â™»ï¸" [perf]="âš¡ï¸" [test]="âœ…" [build]="ğŸ—ï¸"
            [ci]="ğŸ‘·" [style]="ğŸ’„" [revert]="âª" [chore]="ğŸ”§" [other]="ğŸ“¦"
          )

          for t in "${types[@]}"; do : > "notes_${t}.md"; done

          # éå† push äº‹ä»¶çš„ commitsï¼Œè¯†åˆ«ç±»å‹å¹¶å†™å…¥å¯¹åº”æ–‡ä»¶
          # é¢„ç¼–è¯‘åŒ¹é… Conventional Commits çš„æ­£åˆ™
          re='^([a-zA-Z]+)(\([^)]+\))?(!)?:'

          while IFS= read -r row; do
            message=$(echo "$row" | base64 -d | jq -r '.message')
            sha=$(echo "$row" | base64 -d | jq -r '.id')
            subject=$(printf '%s\n' "$message" | head -n1)
            type="other"
            if [[ $subject =~ $re ]]; then
              type="${BASH_REMATCH[1],,}"
            fi
            # å»é™¤ç±»å‹å‰ç¼€ï¼ˆå¦‚ feat(scope)!: ï¼‰åç”¨äºå±•ç¤º
            headline=$(echo "$subject" | sed -E 's/^[a-zA-Z]+(\([^)]+\))?(!)?:[[:space:]]*//')
            # è¿›ä¸€æ­¥ç§»é™¤å¼€å¤´é‡å¤çš„ emoji ä¸ç©ºæ ¼ï¼Œé¿å…ä¸ç±»å‹å¯¹åº”çš„ emoji é‡å¤æ˜¾ç¤º
            headline=$(echo "$headline" | sed -E ':a;s/^(ğŸ¸|ğŸ›|ğŸ“|â™»ï¸|â™»|âš¡ï¸|âš¡|âœ…|ğŸ—ï¸|ğŸ—|ğŸ‘·|ğŸ’„|âª|ğŸ”§|ğŸ“¦)[[:space:]]*//;ta')
            short="${sha:0:7}"
            url="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/commit/$sha"
            emoji="${emojiMap[$type]}"
            echo "* ${emoji} ${headline} ([${short}](${url}))" >> "notes_${type}.md"
          done < <(jq -r '.commits[] | @base64' "$GITHUB_EVENT_PATH")

          # ç»„è£…æœ€ç»ˆ release å†…å®¹
          : > release_body.md
          for t in "${types[@]}"; do
            if [ -s "notes_${t}.md" ]; then
              echo "### ${sectionMap[$t]}" >> release_body.md
              echo >> release_body.md
              cat "notes_${t}.md" >> release_body.md
              echo >> release_body.md
            fi
          done

      - name: Create GitHub Release and upload assets
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.tag.outputs.value }}
          name: ${{ steps.tag.outputs.value }}
          bodyFile: release_body.md
          artifacts: dist/*.zip
          artifactContentType: application/zip
          draft: false
          prerelease: false

